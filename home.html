<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÄéÈ∫ºÂèàÂá∫Âúã</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-color: #4285f4;
            --primary-hover: #3367d6;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #666;
            --white: #fff;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--white);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.25rem;
            background: var(--primary-color);
            color: var(--white);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            color: var(--white);
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 1.5rem;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        /* Add Location Form */
        #add-form {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        #add-form h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        #add-form input,
        #add-form select,
        #add-form textarea {
            /* Added textarea */
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 1rem;
        }

        #add-form textarea {
            min-height: 80px;
            /* Added min-height for textarea */
            resize: vertical;
            /* Allow vertical resizing */
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .form-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        #saveBtn {
            background: #28a745;
            color: var(--white);
        }

        #cancelBtn {
            background: #6c757d;
            color: var(--white);
        }

        /* Lists */
        .list-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-group-btn {
            font-size: 0.8rem;
            color: var(--primary-color);
            cursor: pointer;
        }

        .group-item,
        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .group-item {
            cursor: default;
        }

        .location-item {
            cursor: pointer;
        }

        .group-item:hover,
        .location-item:hover {
            background: var(--light-gray);
        }

        .location-item.active {
            background: #e0eafc;
        }

        .location-info {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            width: 100%;
        }

        .location-info h4 {
            font-weight: 600;
            flex: 1;
            overflow-wrap: break-word;
        }

        .location-info p {
            font-size: 0.8rem;
            color: var(--dark-gray);
            flex-basis: 40%;
            flex-shrink: 0;
            overflow-wrap: break-word;
        }

        .location-actions,
        .group-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edit-btn,
        .delete-btn,
        .edit-group-btn,
        .delete-group-btn {
            visibility: hidden;
            cursor: pointer;
            font-size: 1rem;
        }

        .location-item:hover .edit-btn,
        .location-item:hover .delete-btn,
        .group-item:hover .edit-group-btn,
        .group-item:hover .delete-group-btn {
            visibility: visible;
        }

        .delete-btn,
        .delete-group-btn {
            color: var(--danger-color);
        }

        .group-count {
            background: var(--medium-gray);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .empty-placeholder {
            text-align: center;
            color: var(--dark-gray);
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* --- Map --- */
        #map-container {
            flex: 1;
            height: 100%;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 14px;
            display: none;
        }

        #status.error {
            color: #c62828;
        }

        #status.success {

            color: #2e7d32;

        }



        /* --- Photo Carousel --- */



        .photo-carousel {
            position: fixed;
            bottom: 20px;
            /* Biased towards bottom, not not touching */
            left: 50%;
            transform: translateX(-50%);
            /* Center horizontally */
            width: 1000px;
            /* 70vw at 1920px */
            height: 500px;
            /* 50vh at 1080px */
            background-color: transparent;
            /* No black background */
            z-index: 1002;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.4), 0 12px 40px 0 rgba(0, 0, 0, 0.38);
            /* More prominent shadow */
        }

        .carousel-content {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            /* Take full width of parent */
            height: 100%;
            /* Take full height of parent */
            padding: 0;
            /* Remove padding, let image fill */
            background-color: transparent;
            /* No black background */
        }

        .carousel-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            /* Shadow on image itself */
            border-radius: 8px;
            /* Subtle rounding on image */
        }







        .carousel-counter {



            position: absolute;



            top: 10px;



            left: 50%;



            transform: translateX(-50%);



            color: white;



            background-color: rgba(0, 0, 0, 0.5);



            padding: 2px 8px;



            border-radius: 10px;



            font-size: 0.9rem;



        }







        .carousel-close {







            position: absolute;







            top: 10px;







            right: 20px;







            color: #f1f1f1;







            font-size: 30px;







            font-weight: bold;







            transition: 0.3s;







            cursor: pointer;







            z-index: 1005;
            /* Higher than navigation buttons */







        }







        .carousel-close:hover,



        .carousel-close:focus {



            color: #bbb;



        }







        .carousel-prev,



        .carousel-next {



            cursor: pointer;



            padding: 16px;



            color: white;



            font-weight: bold;



            font-size: 20px;



            transition: 0.6s ease;



            user-select: none;



            z-index: 1004;
            /* Ensure buttons are clickable */



        }







        .carousel-prev:hover,



        .carousel-next:hover {



            background-color: rgba(255, 255, 255, 0.2);



        }
    </style>



</head>



<body>

    <div id="sidebar">

        <div class="sidebar-header">

            <div class="sidebar-header-top">

                <h1>ÊóÖÈÅäÊîªÁï•</h1>

                <input type="text" id="countryCodeInput" placeholder="ÂúãÂÆ∂‰ª£Á¢º" value="jp"
                    style="width: 80px; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.2); color: var(--white); font-size: 0.9rem;">

            </div>

            <p id="location-count">Â∑≤Êî∂Ëóè 0 ÂÄãÂú∞Èªû</p>

        </div>



        <div class="sidebar-content">

            <div class="list-section">

                <h3>

                    <span>Áæ§ÁµÑ</span>

                    <span id="add-group-btn" class="add-group-btn">+ Êñ∞Â¢ûÁæ§ÁµÑ</span>

                </h3>

                <div id="groups-container"></div>

            </div>



            <button id="show-form-btn" class="btn">Êñ∞Â¢ûÂú∞Èªû</button>



            <div id="add-form" style="display: none;">

                <h3>Êñ∞Â¢ûÂú∞Èªû</h3>

                <input type="text" id="nameInput" placeholder="Âú∞ÈªûÂêçÁ®± (ÂèØÈÅ∏)">

                <input type="text" id="addressInput" placeholder="Ëº∏ÂÖ•Âú∞ÂùÄÔºå‰æãÂ¶ÇÔºöÂè∞Âåó101" required>

                <select id="groupSelect"></select>

                <textarea id="detailsInput" placeholder="Âú∞ÈªûÁ¥∞ÁØÄ (ÊúÄÂ§ö256Â≠ó)" maxlength="256"></textarea>

                <label for="photoInput"
                    style="font-size: 0.9rem; color: var(--dark-gray); margin-top: 10px; display: block;">‰∏äÂÇ≥ÁÖßÁâá:</label>

                <input type="file" id="photoInput" accept="image/*" multiple style="margin-bottom: 10px;">

                <div class="form-buttons">

                    <button id="saveBtn">ÂÑ≤Â≠ò</button>

                    <button id="cancelBtn">ÂèñÊ∂à</button>

                </div>

            </div>



            <div class="list-section" style="margin-top: 1.5rem;">

                <h3>ÊâÄÊúâÂú∞Èªû</h3>

                <div id="locations-container"></div>

            </div>

        </div>

    </div>



    <div id="map-container"></div>

    <div id="status"></div>



    <div id="photo-carousel" class="photo-carousel" style="display: none;">

        <span class="carousel-close">&times;</span>

        <div class="carousel-content">

            <a class="carousel-prev">&#10094;</a>

            <div class="carousel-slide">

                <img id="carousel-image">

                <div id="carousel-counter" class="carousel-counter"></div>

            </div>

            <a class="carousel-next">&#10095;</a>

        </div>

    </div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mapContainer = document.getElementById('map-container');
            const statusDiv = document.getElementById('status');
            const showFormBtn = document.getElementById('show-form-btn');
            const addForm = document.getElementById('add-form');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const nameInput = document.getElementById('nameInput');
            const addressInput = document.getElementById('addressInput');
            const groupSelect = document.getElementById('groupSelect');
            const detailsInput = document.getElementById('detailsInput');
            const addGroupBtn = document.getElementById('add-group-btn');
            const locationCountEl = document.getElementById('location-count');
            const groupsContainer = document.getElementById('groups-container');
            const locationsContainer = document.getElementById('locations-container');
            const formTitle = addForm.querySelector('h3');
            const countryCodeInput = document.getElementById('countryCodeInput');

            // --- App State ---
            let map;
            let locations = [];
            let groups = [];
            let markers = [];
            let activeLocationId = null;
            let editingLocationId = null;
            let currentCarouselPhotos = [];
            let currentCarouselIndex = 0;

            // --- Carousel Logic ---
            function showPhotoCarousel(locationId) {
                const loc = locations.find(l => l.id === locationId);
                if (!loc || !loc.photos || loc.photos.length === 0) {
                    // If no photos, just open the regular popup
                    const marker = markers.find(m => m.options.id === locationId);
                    if (marker) marker.openPopup();
                    return;
                }

                currentCarouselPhotos = loc.photos;
                currentCarouselIndex = 0;
                document.getElementById('photo-carousel').style.display = 'block';
                document.addEventListener('keydown', handleCarouselKeys);
                showSlide(currentCarouselIndex);
                updateCarouselNavButtons(); // Initial button state
            }

            function closeCarousel() {
                console.log('Close button clicked!'); // Debugging line
                document.getElementById('photo-carousel').style.display = 'none';
                document.removeEventListener('keydown', handleCarouselKeys);
                currentCarouselPhotos = [];
            }

            function plusSlides(n) {
                let newIndex = currentCarouselIndex + n;
                if (newIndex >= currentCarouselPhotos.length) {
                    newIndex = currentCarouselPhotos.length - 1; // Stop at last
                }
                if (newIndex < 0) {
                    newIndex = 0; // Stop at first
                }
                if (newIndex !== currentCarouselIndex) { // Only update if index changed
                    currentCarouselIndex = newIndex;
                    showSlide(currentCarouselIndex);
                }
                updateCarouselNavButtons();
            }

            function updateCarouselNavButtons() {
                const prevBtn = document.querySelector('.carousel-prev');
                const nextBtn = document.querySelector('.carousel-next');
                if (currentCarouselPhotos.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = (currentCarouselIndex === 0) ? 'none' : 'block';
                    nextBtn.style.display = (currentCarouselIndex === currentCarouselPhotos.length - 1) ? 'none' : 'block';
                }
            }

            function showSlide(n) {
                document.getElementById('carousel-image').src = currentCarouselPhotos[n];
                document.getElementById('carousel-counter').textContent = `${n + 1} / ${currentCarouselPhotos.length}`;
                updateCarouselNavButtons(); // Update button state after slide change
            }

            function handleCarouselKeys(e) {
                if (e.key === 'ArrowLeft') {
                    plusSlides(-1);
                } else if (e.key === 'ArrowRight') {
                    plusSlides(1);
                } else if (e.key === 'Escape') {
                    closeCarousel();
                }
            }



            // --- Utility Functions ---
            function readAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            function cleanAddress(address) {
                // Remove content within parentheses
                let cleaned = address.replace(/\([^)]*\)/g, '').trim();
                // Remove extra spaces
                cleaned = cleaned.replace(/\s\s+/g, ' ');
                return cleaned;
            }

            // --- Data Persistence ---
            function saveData() {
                localStorage.setItem('map-locations', JSON.stringify(locations));
                localStorage.setItem('map-groups', JSON.stringify(groups));
            }

            function loadData() {
                const savedLocations = localStorage.getItem('map-locations');
                locations = savedLocations ? JSON.parse(savedLocations) : [];

                const savedGroups = localStorage.getItem('map-groups');
                let loadedGroups = savedGroups ? JSON.parse(savedGroups) : [];

                // Define default groups with icons and colors
                const defaultGroups = [
                    { name: 'È§êÂª≥', icon: 'üç£' },
                    { name: 'Â±ãÂè∞Â∞èÂêÉ', icon: 'üç°' },
                    { name: 'vibeÊôØÈªû', icon: '‚õ©Ô∏è' },
                    { name: 'Âª∫ÁØâ', icon: 'üèõÔ∏è' },
                    { name: 'Ë≥ºÁâ©', icon: 'üîñ' }
                ];

                if (loadedGroups.length === 0) {
                    groups = defaultGroups;
                } else {
                    // Check if loaded groups are old string format or new object format
                    if (typeof loadedGroups[0] === 'string') {
                        // Old string format, convert to new object format
                        groups = loadedGroups.map(groupName => {
                            const existingDefault = defaultGroups.find(g => g.name === groupName);
                            return existingDefault || { name: groupName, icon: 'üìç' };
                        });
                    } else {
                        // New object format, ensure all properties are present
                        groups = loadedGroups.map(group => ({
                            ...group,
                            icon: group.icon || 'üìç' // Default icon if missing
                        }));
                    }
                }

                // If after loading, groups are still empty, use default
                if (groups.length === 0) {
                    groups = defaultGroups;
                }

                // Ensure locations' group property matches the name of group objects
                locations = locations.map(loc => {
                    const correspondingGroup = groups.find(g => g.name === loc.group);
                    if (!correspondingGroup) {
                        // If a location's group doesn't exist in the current groups, assign a default or remove it
                        // For now, let's assign it to the first default group or a generic group
                        return { ...loc, group: groups[0] ? groups[0].name : 'Êú™ÂàÜÈ°û' };
                    }
                    return loc;
                });


            }

            // --- UI Rendering ---
            function renderUI() {
                renderGroups();
                renderLocations();
                renderMapMarkers();
                updateLocationCount();
            }

            function renderGroups() {
                groupsContainer.innerHTML = '';
                groupSelect.innerHTML = '';

                if (groups.length === 0) {
                    groupsContainer.innerHTML = '<p class="empty-placeholder">Â∞öÁÑ°Áæ§ÁµÑ</p>';
                }

                groups.forEach(group => {
                    const count = locations.filter(loc => loc.group === group.name).length;
                    const groupEl = document.createElement('div');
                    groupEl.className = 'group-item';
                    groupEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem; width: 24px; text-align: center;">${group.icon}</span>
                            <span>${group.name}</span>
                        </div>
                        <div class="group-actions">
                            <span class="group-count">${count}</span>
                            <span class="edit-group-btn" data-group-name="${group.name}">‚úèÔ∏è</span>
                            <span class="delete-group-btn" data-group-name="${group.name}">üóëÔ∏è</span>
                        </div>
                    `;
                    groupsContainer.appendChild(groupEl);

                    const optionEl = document.createElement('option');
                    optionEl.value = group.name;
                    optionEl.textContent = group.name;
                    groupSelect.appendChild(optionEl);
                });
            }

            function renderLocations() {
                locationsContainer.innerHTML = '';
                if (locations.length === 0) {
                    locationsContainer.innerHTML = '<p class="empty-placeholder">Â∞öÁÑ°Âú∞ÈªûÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢û</p>';
                    return;
                }

                locations.forEach(loc => {
                    const locEl = document.createElement('div');
                    locEl.className = 'location-item';
                    locEl.dataset.id = loc.id;
                    if (loc.id === activeLocationId) {
                        locEl.classList.add('active');
                    }

                    locEl.innerHTML = `
                        <div class="location-info">
                            <h4>${loc.name}</h4>
                            <p>${loc.details || ''}</p>
                        </div>
                        <div class="location-actions">
                            <span class="edit-btn" data-id="${loc.id}">‚úèÔ∏è</span>
                            <span class="delete-btn" data-id="${loc.id}">‚úï</span>
                        </div>
                    `;

                    locEl.querySelector('.location-info').addEventListener('click', () => {
                        map.setView([loc.lat, loc.lon], 16);
                        const marker = markers.find(m => m.options.id === loc.id);
                        if (marker) marker.openPopup();
                        activeLocationId = loc.id;
                        renderLocations();
                    });

                    locationsContainer.appendChild(locEl);
                });
            }

            function updateLocationCount() {
                locationCountEl.textContent = `Â∑≤Êî∂Ëóè ${locations.length} ÂÄãÂú∞Èªû`;
            }

            // --- Map Logic ---
            function initMap() {
                map = L.map(mapContainer).setView([35.6812, 139.7595], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            }

            function renderMapMarkers() {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                locations.forEach(loc => {
                    const group = groups.find(g => g.name === loc.group);
                    const markerIcon = group ? group.icon : 'üìç';

                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="font-size: 28px; text-shadow: 0 0 3px #fff;">${markerIcon}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });

                    const marker = L.marker([loc.lat, loc.lon], {
                        icon: customIcon,
                        id: loc.id,
                        draggable: false
                    }).addTo(map);

                    let dragTimer;
                    marker.on('mousedown', () => {
                        dragTimer = setTimeout(() => {
                            marker.dragging.enable();
                            map.getContainer().style.cursor = 'move';
                        }, 200);
                    });

                    marker.on('mouseup', () => {
                        clearTimeout(dragTimer);
                        map.getContainer().style.cursor = '';
                    });

                    marker.on('dragend', async (event) => {
                        marker.dragging.disable();
                        map.getContainer().style.cursor = '';
                        const newLatLng = event.target.getLatLng();
                        await updateLocationByCoords(loc.id, newLatLng);
                    });

                    marker.on('click', () => {
                        showPhotoCarousel(loc.id);
                    });


                    marker.bindPopup(`<b>${loc.name}</b><br>${loc.details || ''}`);
                    markers.push(marker);
                });
            }

            // --- Form & State Management ---
            function resetFormState() {
                editingLocationId = null;
                addForm.style.display = 'none';
                showFormBtn.style.display = 'block';

                formTitle.textContent = 'Êñ∞Â¢ûÂú∞Èªû';
                saveBtn.textContent = 'ÂÑ≤Â≠ò';

                nameInput.value = '';
                addressInput.value = '';
                addressInput.disabled = false;
                detailsInput.value = '';
                document.getElementById('photoInput').value = '';
            }

            function startEdit(id) {
                const locToEdit = locations.find(loc => loc.id === id);
                if (!locToEdit) return;

                editingLocationId = id;

                addForm.style.display = 'block';
                showFormBtn.style.display = 'none';

                formTitle.textContent = 'Á∑®ËºØÂú∞Èªû';
                saveBtn.textContent = 'Êõ¥Êñ∞';

                nameInput.value = locToEdit.name;
                addressInput.value = locToEdit.address;
                addressInput.disabled = false; // Enable address editing
                groupSelect.value = locToEdit.group;
                detailsInput.value = locToEdit.details || '';
            }

            // --- Core Functionality ---
            async function updateLocationByCoords(id, latLng) {
                showStatus('Ê≠£Âú®Êõ¥Êñ∞Â∫ßÊ®ôËàáÂú∞ÂùÄ...');
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latLng.lat}&lon=${latLng.lng}&accept-language=zh-TW`);
                    const data = await response.json();

                    if (data && data.display_name) {
                        const locIndex = locations.findIndex(l => l.id === id);
                        if (locIndex > -1) {
                            locations[locIndex].lat = latLng.lat;
                            locations[locIndex].lon = latLng.lng;
                            locations[locIndex].address = data.display_name;

                            const marker = markers.find(m => m.options.id === id);
                            if (marker) {
                                marker.bindPopup(`<b>${locations[locIndex].name}</b><br>${locations[locIndex].details || ''}`);
                            }

                            saveData();
                            renderLocations();
                            showStatus('‚úì Âú∞Èªû‰ΩçÁΩÆËàáÂú∞ÂùÄÂ∑≤Êõ¥Êñ∞', 'success');
                        }
                    } else {
                        showStatus('‚ùå ÁÑ°Ê≥ïÊâæÂà∞Â∞çÊáâÂú∞ÂùÄÔºåÂú∞ÈªûÊú™Êõ¥Êñ∞', 'error');
                        renderMapMarkers(); // Revert marker position
                    }
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    showStatus('‚ùå Âú∞ÂùÄÊõ¥Êñ∞Â§±Êïó', 'error');
                    renderMapMarkers(); // Revert marker position
                }
            }

            async function handleSave() {
                if (editingLocationId !== null) {
                    await updateLocation(editingLocationId);
                } else {
                    await searchAndAddLocation();
                }
            }

            async function updateLocation(id) {
                const locIndex = locations.findIndex(loc => loc.id === id);
                if (locIndex === -1) return;

                const originalLocation = locations[locIndex];
                const newAddress = addressInput.value.trim();
                const newName = nameInput.value.trim();
                const newGroup = groupSelect.value;
                const newDetails = detailsInput.value.trim();
                const photoFiles = Array.from(document.getElementById('photoInput').files).slice(0, 20); // Limit to 20 files
                let photoDataArray = originalLocation.photos || []; // Keep old photos by default

                if (photoFiles.length > 0) { // If new files are selected, replace old ones
                    photoDataArray = [];
                    for (const file of photoFiles) {
                        photoDataArray.push(await readAsDataURL(file));
                    }
                }

                // If address hasn't changed, simple update and exit
                if (newAddress === originalLocation.address) {
                    locations[locIndex].name = newName || 'Êú™ÂëΩÂêçÂú∞Èªû';
                    locations[locIndex].group = newGroup;
                    locations[locIndex].details = newDetails;
                    locations[locIndex].photos = photoDataArray; // Update photos
                    saveData();
                    renderUI();
                    resetFormState();
                    showStatus('‚úì Âú∞ÈªûÂ∑≤Êõ¥Êñ∞', 'success');
                    return;
                }

                // Address has changed, perform re-geocoding
                saveBtn.disabled = true;
                showStatus('Âú∞ÂùÄÂ∑≤ËÆäÊõ¥ÔºåÈáçÊñ∞ÊêúÂ∞ãÂ∫ßÊ®ô...');

                const currentCenter = map.getCenter();
                const currentBounds = map.getBounds();
                const latDiff = currentBounds.getNorth() - currentBounds.getSouth();
                const lonDiff = currentBounds.getEast() - currentBounds.getWest();

                const expandedLatDiff = latDiff * 10;
                const expandedLonDiff = lonDiff * 10;

                const minLat = currentCenter.lat - expandedLatDiff / 2;
                const maxLat = currentCenter.lat + expandedLatDiff / 2;
                const minLon = currentCenter.lng - expandedLonDiff / 2;
                const maxLon = currentCenter.lng + expandedLonDiff / 2;

                const viewbox = `${minLon},${minLat},${maxLon},${maxLat}`;
                const countrycodes = countryCodeInput.value.trim();

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanAddress(newAddress))}&limit=1&viewbox=${viewbox}&bounded=1&countrycodes=${countrycodes}`
                    );
                    const data = await response.json();

                    if (data.length > 0) {
                        const result = data[0];
                        locations[locIndex].name = newName || result.display_name.split(',')[0];
                        locations[locIndex].address = result.display_name;
                        locations[locIndex].lat = parseFloat(result.lat);
                        locations[locIndex].lon = parseFloat(result.lon);
                        locations[locIndex].group = newGroup;
                        locations[locIndex].details = newDetails;
                        locations[locIndex].photos = photoDataArray; // Update photos

                        saveData();
                        renderUI();
                        resetFormState();
                        map.setView([locations[locIndex].lat, locations[locIndex].lon], 15);
                        showStatus('‚úì Âú∞ÈªûÂ∑≤ÊàêÂäüÊõ¥Êñ∞Â∫ßÊ®ô', 'success');
                    } else {
                        showStatus('‚ùå Êâæ‰∏çÂà∞Êñ∞ÁöÑÂú∞ÂùÄÔºåÂú∞ÈªûÊú™Êõ¥Êñ∞', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå ÊêúÂ∞ãÂ§±ÊïóÔºåÂú∞ÈªûÊú™Êõ¥Êñ∞', 'error');
                    console.error('Update geocoding error:', error);
                } finally {
                    saveBtn.disabled = false;
                }
            }

            async function searchAndAddLocation() {
                const address = addressInput.value.trim();
                if (!address) {
                    showStatus('Ë´ãËº∏ÂÖ•Âú∞ÂùÄ', 'error');
                    return;
                }

                saveBtn.disabled = true;
                const currentCenter = map.getCenter();
                const currentBounds = map.getBounds();
                const latDiff = currentBounds.getNorth() - currentBounds.getSouth();
                const lonDiff = currentBounds.getEast() - currentBounds.getWest();

                const expandedLatDiff = latDiff * 10;
                const expandedLonDiff = lonDiff * 10;

                const minLat = currentCenter.lat - expandedLatDiff / 2;
                const maxLat = currentCenter.lat + expandedLatDiff / 2;
                const minLon = currentCenter.lng - expandedLonDiff / 2;
                const maxLon = currentCenter.lng + expandedLonDiff / 2;

                const viewbox = `${minLon},${minLat},${maxLon},${maxLat}`;
                const countrycodes = countryCodeInput.value.trim();

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanAddress(address))}&limit=1&viewbox=${viewbox}&bounded=1&countrycodes=${countrycodes}`
                    );
                    const data = await response.json();

                    if (data.length > 0) {
                        const result = data[0];
                        const photoFiles = Array.from(document.getElementById('photoInput').files).slice(0, 20); // Limit to 20 files
                        const photoDataArray = [];
                        for (const file of photoFiles) {
                            photoDataArray.push(await readAsDataURL(file));
                        }

                        const newLocation = {
                            id: Date.now(),
                            name: nameInput.value.trim() || result.display_name.split(',')[0],
                            address: result.display_name,
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon),
                            group: groupSelect.value,
                            details: detailsInput.value.trim(),
                            photos: photoDataArray // Store as an array
                        };

                        locations.unshift(newLocation);
                        saveData();
                        renderUI();

                        map.setView([newLocation.lat, newLocation.lon], 15);
                        showStatus('‚úì Âú∞ÈªûÂ∑≤Êñ∞Â¢û', 'success');
                        resetFormState();

                    } else {
                        showStatus('‚ùå Êâæ‰∏çÂà∞Âú∞ÂùÄ', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå ÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø', 'error');
                    console.error('Search error:', error);
                } finally {
                    saveBtn.disabled = false;
                }
            }

            function deleteLocation(id) {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Âú∞ÈªûÂóéÔºü')) {
                    locations = locations.filter(loc => loc.id !== id);
                    if (activeLocationId === id) activeLocationId = null;
                    if (editingLocationId === id) resetFormState();

                    saveData();
                    renderUI();
                    showStatus('Âú∞ÈªûÂ∑≤Âà™Èô§', 'success');
                }
            }

            function addNewGroup() {
                const newGroup = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁæ§ÁµÑÂêçÁ®±Ôºö');
                if (newGroup && newGroup.trim() !== '' && !groups.some(g => g.name === newGroup.trim())) {
                    // Assign a default icon for new groups
                    const defaultIcon = 'üìç'; // You can expand this to allow user selection later
                    groups.push({ name: newGroup.trim(), icon: defaultIcon });
                    saveData();
                    renderUI();
                } else if (groups.some(g => g.name === newGroup.trim())) {
                    alert('Ë©≤Áæ§ÁµÑÂêçÁ®±Â∑≤Â≠òÂú®ÔºÅ');
                }
            }

            function startEditGroup(oldGroupName) {
                const newGroupName = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁæ§ÁµÑÂêçÁ®±Ôºö', oldGroupName);

                if (!newGroupName || newGroupName.trim() === '' || newGroupName.trim() === oldGroupName) {
                    return; // User cancelled or entered same/empty name
                }
                if (groups.some(g => g.name === newGroupName.trim())) {
                    alert('Ë©≤Áæ§ÁµÑÂêçÁ®±Â∑≤Â≠òÂú®ÔºÅ');
                    return;
                }

                const finalNewName = newGroupName.trim();

                // Update group name in the groups array
                const groupIndex = groups.findIndex(g => g.name === oldGroupName);
                if (groupIndex > -1) {
                    groups[groupIndex].name = finalNewName;
                }

                // Update group name for all associated locations
                locations.forEach(loc => {
                    if (loc.group === oldGroupName) {
                        loc.group = finalNewName;
                    }
                });

                saveData();
                renderUI();
                showStatus('‚úì Áæ§ÁµÑÂ∑≤Êõ¥Êñ∞', 'success');
            }

            function deleteGroup(groupName) {
                const isGroupInUse = locations.some(loc => loc.group === groupName);
                if (isGroupInUse) {
                    alert(`ÁÑ°Ê≥ïÂà™Èô§Áæ§ÁµÑ "${groupName}"ÔºåÂõ†ÁÇ∫Ë£°Èù¢ÈÇÑÊúâÂú∞Èªû„ÄÇ\nË´ãÂÖàÂ∞áÂú∞ÈªûÁßªËá≥ÂÖ∂‰ªñÁæ§ÁµÑÂæåÂÜçË©¶„ÄÇ`);
                    return;
                }

                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Áæ§ÁµÑ "${groupName}" ÂóéÔºü`)) {
                    groups = groups.filter(g => g.name !== groupName);
                    saveData();
                    renderUI();
                    showStatus('Áæ§ÁµÑÂ∑≤Âà™Èô§', 'success');
                }
            }

            function showStatus(message, type = '') {
                statusDiv.textContent = message;
                statusDiv.className = type;
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }

            // --- Event Listeners ---
            document.querySelector('.carousel-close').addEventListener('click', closeCarousel);
            document.querySelector('.carousel-prev').addEventListener('click', () => plusSlides(-1));
            document.querySelector('.carousel-next').addEventListener('click', () => plusSlides(1));

            showFormBtn.addEventListener('click', () => {
                resetFormState();
                addForm.style.display = 'block';
                showFormBtn.style.display = 'none';
                addressInput.focus();
            });

            cancelBtn.addEventListener('click', resetFormState);
            saveBtn.addEventListener('click', handleSave);
            addGroupBtn.addEventListener('click', addNewGroup);

            locationsContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('delete-btn')) {
                    const id = parseInt(target.dataset.id, 10);
                    deleteLocation(id);
                } else if (target.classList.contains('edit-btn')) {
                    const id = parseInt(target.dataset.id, 10);
                    startEdit(id);
                }
            });

            groupsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const groupName = target.dataset.groupName;
                if (!groupName) return;

                if (target.classList.contains('edit-group-btn')) {
                    startEditGroup(groupName);
                } else if (target.classList.contains('delete-group-btn')) {
                    deleteGroup(groupName);
                }
            });

            // --- Initialization ---
            loadData();
            initMap();
            renderUI();
        });
    </script>
</body>

</html>