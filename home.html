<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÂú∞ÂúñÊî∂Ëóè</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-color: #4285f4;
            --primary-hover: #3367d6;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #666;
            --white: #fff;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 320px;
            height: 100%;
            background: var(--white);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.25rem;
            background: var(--primary-color);
            color: var(--white);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            color: var(--white);
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 1.5rem;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        /* Add Location Form */
        #add-form {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        #add-form h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        #add-form input,
        #add-form select,
        #add-form textarea {
            /* Added textarea */
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 1rem;
        }

        #add-form textarea {
            min-height: 80px;
            /* Added min-height for textarea */
            resize: vertical;
            /* Allow vertical resizing */
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .form-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        #saveBtn {
            background: #28a745;
            color: var(--white);
        }

        #cancelBtn {
            background: #6c757d;
            color: var(--white);
        }

        /* Lists */
        .list-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-group-btn {
            font-size: 0.8rem;
            color: var(--primary-color);
            cursor: pointer;
        }

        .group-item,
        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .group-item {
            cursor: default;
        }

        .location-item {
            cursor: pointer;
        }

        .group-item:hover,
        .location-item:hover {
            background: var(--light-gray);
        }

        .location-item.active {
            background: #e0eafc;
        }

        .location-info h4 {
            font-weight: 600;
        }

        .location-info p {
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .location-actions,
        .group-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edit-btn,
        .delete-btn,
        .edit-group-btn,
        .delete-group-btn {
            visibility: hidden;
            cursor: pointer;
            font-size: 1rem;
        }

        .location-item:hover .edit-btn,
        .location-item:hover .delete-btn,
        .group-item:hover .edit-group-btn,
        .group-item:hover .delete-group-btn {
            visibility: visible;
        }

        .delete-btn,
        .delete-group-btn {
            color: var(--danger-color);
        }

        .group-count {
            background: var(--medium-gray);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .empty-placeholder {
            text-align: center;
            color: var(--dark-gray);
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* --- Map --- */
        #map-container {
            flex: 1;
            height: 100%;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 14px;
            display: none;
        }

        #status.error {
            color: #c62828;
        }

        #status.success {
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>ÊóÖÈÅäÊîªÁï•</h1>
            <p id="location-count">Â∑≤Êî∂Ëóè 0 ÂÄãÂú∞Èªû</p>
        </div>

        <div class="sidebar-content">
            <div class="list-section">
                <h3>
                    <span>Áæ§ÁµÑ</span>
                    <span id="add-group-btn" class="add-group-btn">+ Êñ∞Â¢ûÁæ§ÁµÑ</span>
                </h3>
                <div id="groups-container"></div>
            </div>

            <button id="show-form-btn" class="btn">Êñ∞Â¢ûÂú∞Èªû</button>

            <div id="add-form" style="display: none;">
                <h3>Êñ∞Â¢ûÂú∞Èªû</h3>
                <input type="text" id="nameInput" placeholder="Âú∞ÈªûÂêçÁ®± (ÂèØÈÅ∏)">
                <input type="text" id="addressInput" placeholder="Ëº∏ÂÖ•Âú∞ÂùÄÔºå‰æãÂ¶ÇÔºöÂè∞Âåó101" required>
                <select id="groupSelect"></select>
                <textarea id="detailsInput" placeholder="Âú∞ÈªûÁ¥∞ÁØÄ (ÊúÄÂ§ö256Â≠ó)" maxlength="256"></textarea>
                <div class="form-buttons">
                    <button id="saveBtn">ÂÑ≤Â≠ò</button>
                    <button id="cancelBtn">ÂèñÊ∂à</button>
                </div>
            </div>

            <div class="list-section" style="margin-top: 1.5rem;">
                <h3>ÊâÄÊúâÂú∞Èªû</h3>
                <div id="locations-container"></div>
            </div>
        </div>
    </div>

    <div id="map-container"></div>
    <div id="status"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mapContainer = document.getElementById('map-container');
            const statusDiv = document.getElementById('status');
            const showFormBtn = document.getElementById('show-form-btn');
            const addForm = document.getElementById('add-form');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const nameInput = document.getElementById('nameInput');
            const addressInput = document.getElementById('addressInput');
            const groupSelect = document.getElementById('groupSelect');
            const detailsInput = document.getElementById('detailsInput'); // New: Details Input
            const addGroupBtn = document.getElementById('add-group-btn');
            const locationCountEl = document.getElementById('location-count');
            const groupsContainer = document.getElementById('groups-container');
            const locationsContainer = document.getElementById('locations-container');
            const formTitle = addForm.querySelector('h3');

            // --- App State ---
            let map;
            let locations = [];
            let groups = [];
            let markers = [];
            let activeLocationId = null;
            let editingLocationId = null;

            // --- Data Persistence ---
            function saveData() {
                localStorage.setItem('map-locations', JSON.stringify(locations));
                localStorage.setItem('map-groups', JSON.stringify(groups));
            }

            function loadData() {
                const savedLocations = localStorage.getItem('map-locations');
                locations = savedLocations ? JSON.parse(savedLocations) : [];

                const savedGroups = localStorage.getItem('map-groups');
                groups = savedGroups && JSON.parse(savedGroups).length > 0 ? JSON.parse(savedGroups) : ['ÁæéÈ£ü', 'Ëá™ÁÑ∂È¢®ÊôØ', 'ÂíñÂï°Âª≥', 'ÊóÖÈÅäÊôØÈªû'];
            }

            // --- UI Rendering ---
            function renderUI() {
                renderGroups();
                renderLocations();
                renderMapMarkers();
                updateLocationCount();
            }

            function renderGroups() {
                groupsContainer.innerHTML = '';
                groupSelect.innerHTML = '';

                if (groups.length === 0) {
                    groupsContainer.innerHTML = '<p class="empty-placeholder">Â∞öÁÑ°Áæ§ÁµÑ</p>';
                }

                groups.forEach(group => {
                    const count = locations.filter(loc => loc.group === group).length;
                    const groupEl = document.createElement('div');
                    groupEl.className = 'group-item';
                    groupEl.innerHTML = `
                        <span>${group}</span>
                        <div class="group-actions">
                            <span class="group-count">${count}</span>
                            <span class="edit-group-btn" data-group-name="${group}">‚úèÔ∏è</span>
                            <span class="delete-group-btn" data-group-name="${group}">üóëÔ∏è</span>
                        </div>
                    `;
                    groupsContainer.appendChild(groupEl);

                    const optionEl = document.createElement('option');
                    optionEl.value = group;
                    optionEl.textContent = group;
                    groupSelect.appendChild(optionEl);
                });
            }

            function renderLocations() {
                locationsContainer.innerHTML = '';
                if (locations.length === 0) {
                    locationsContainer.innerHTML = '<p class="empty-placeholder">Â∞öÁÑ°Âú∞ÈªûÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢û</p>';
                    return;
                }

                locations.forEach(loc => {
                    const locEl = document.createElement('div');
                    locEl.className = 'location-item';
                    locEl.dataset.id = loc.id;
                    if (loc.id === activeLocationId) {
                        locEl.classList.add('active');
                    }

                    locEl.innerHTML = `
                        <div class="location-info">
                            <h4>${loc.name}</h4>
                            <p>${loc.address}</p>
                        </div>
                        <div class="location-actions">
                            <span class="edit-btn" data-id="${loc.id}">‚úèÔ∏è</span>
                            <span class="delete-btn" data-id="${loc.id}">‚úï</span>
                        </div>
                    `;

                    locEl.querySelector('.location-info').addEventListener('click', () => {
                        map.setView([loc.lat, loc.lon], 16);
                        const marker = markers.find(m => m.options.id === loc.id);
                        if (marker) marker.openPopup();
                        activeLocationId = loc.id;
                        renderLocations();
                    });

                    locationsContainer.appendChild(locEl);
                });
            }

            function updateLocationCount() {
                locationCountEl.textContent = `Â∑≤Êî∂Ëóè ${locations.length} ÂÄãÂú∞Èªû`;
            }

            // --- Map Logic ---
            function initMap() {
                map = L.map(mapContainer).setView([25.033, 121.565], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            }

            function renderMapMarkers() {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lon], { id: loc.id }).addTo(map);
                    marker.bindPopup(`<b>${loc.name}</b>`);
                    markers.push(marker);
                });
            }

            // --- Form & State Management ---
            function resetFormState() {
                editingLocationId = null;
                addForm.style.display = 'none';
                showFormBtn.style.display = 'block';

                formTitle.textContent = 'Êñ∞Â¢ûÂú∞Èªû';
                saveBtn.textContent = 'ÂÑ≤Â≠ò';

                nameInput.value = '';
                addressInput.value = '';
                addressInput.disabled = false;
                detailsInput.value = ''; // New: Clear details input
            }

            function startEdit(id) {
                const locToEdit = locations.find(loc => loc.id === id);
                if (!locToEdit) return;

                editingLocationId = id;

                addForm.style.display = 'block';
                showFormBtn.style.display = 'none';

                formTitle.textContent = 'Á∑®ËºØÂú∞Èªû';
                saveBtn.textContent = 'Êõ¥Êñ∞';

                nameInput.value = locToEdit.name;
                addressInput.value = locToEdit.address;
                addressInput.disabled = false; // Enable address editing
                groupSelect.value = locToEdit.group;
                detailsInput.value = locToEdit.details || ''; // New: Populate details input
            }

            // --- Core Functionality ---
            async function handleSave() {
                if (editingLocationId !== null) {
                    await updateLocation(editingLocationId);
                } else {
                    await searchAndAddLocation();
                }
            }

            async function updateLocation(id) {
                const locIndex = locations.findIndex(loc => loc.id === id);
                if (locIndex === -1) return;

                const originalLocation = locations[locIndex];
                const newAddress = addressInput.value.trim();
                const newName = nameInput.value.trim();
                const newGroup = groupSelect.value;
                const newDetails = detailsInput.value.trim(); // New: Get details

                // If address hasn't changed, simple update and exit
                if (newAddress === originalLocation.address) {
                    locations[locIndex].name = newName || 'Êú™ÂëΩÂêçÂú∞Èªû';
                    locations[locIndex].group = newGroup;
                    locations[locIndex].details = newDetails; // New: Update details
                    saveData();
                    renderUI();
                    resetFormState();
                    showStatus('‚úì Âú∞ÈªûÂ∑≤Êõ¥Êñ∞', 'success');
                    return;
                }

                // Address has changed, perform re-geocoding
                saveBtn.disabled = true;
                showStatus('Âú∞ÂùÄÂ∑≤ËÆäÊõ¥ÔºåÈáçÊñ∞ÊêúÂ∞ãÂ∫ßÊ®ô...');

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(newAddress)}&limit=1&accept-language=zh-TW,zh`
                    );
                    const data = await response.json();

                    if (data.length > 0) {
                        const result = data[0];
                        locations[locIndex].name = newName || result.display_name.split(',')[0];
                        locations[locIndex].address = result.display_name;
                        locations[locIndex].lat = parseFloat(result.lat);
                        locations[locIndex].lon = parseFloat(result.lon);
                        locations[locIndex].group = newGroup;
                        locations[locIndex].details = newDetails; // New: Update details

                        saveData();
                        renderUI();
                        resetFormState();
                        map.setView([locations[locIndex].lat, locations[locIndex].lon], 15);
                        showStatus('‚úì Âú∞ÈªûÂ∑≤ÊàêÂäüÊõ¥Êñ∞Â∫ßÊ®ô', 'success');
                    } else {
                        showStatus('‚ùå Êâæ‰∏çÂà∞Êñ∞ÁöÑÂú∞ÂùÄÔºåÂú∞ÈªûÊú™Êõ¥Êñ∞', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå ÊêúÂ∞ãÂ§±ÊïóÔºåÂú∞ÈªûÊú™Êõ¥Êñ∞', 'error');
                    console.error('Update geocoding error:', error);
                } finally {
                    saveBtn.disabled = false;
                }
            }

            async function searchAndAddLocation() {
                const address = addressInput.value.trim();
                if (!address) {
                    showStatus('Ë´ãËº∏ÂÖ•Âú∞ÂùÄ', 'error');
                    return;
                }

                saveBtn.disabled = true;
                showStatus('ÊêúÂ∞ã‰∏≠...');

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh-TW,zh`
                    );
                    const data = await response.json();

                    if (data.length > 0) {
                        const result = data[0];
                        const newLocation = {
                            id: Date.now(),
                            name: nameInput.value.trim() || result.display_name.split(',')[0],
                            address: result.display_name,
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon),
                            group: groupSelect.value,
                            details: detailsInput.value.trim() // New: Add details
                        };

                        locations.unshift(newLocation);
                        saveData();
                        renderUI();

                        map.setView([newLocation.lat, newLocation.lon], 15);
                        showStatus('‚úì Âú∞ÈªûÂ∑≤Êñ∞Â¢û', 'success');
                        resetFormState();

                    } else {
                        showStatus('‚ùå Êâæ‰∏çÂà∞Âú∞ÂùÄ', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå ÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø', 'error');
                    console.error('Search error:', error);
                } finally {
                    saveBtn.disabled = false;
                }
            }

            function deleteLocation(id) {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Âú∞ÈªûÂóéÔºü')) {
                    locations = locations.filter(loc => loc.id !== id);
                    if (activeLocationId === id) activeLocationId = null;
                    if (editingLocationId === id) resetFormState();

                    saveData();
                    renderUI();
                    showStatus('Âú∞ÈªûÂ∑≤Âà™Èô§', 'success');
                }
            }

            function addNewGroup() {
                const newGroup = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁæ§ÁµÑÂêçÁ®±Ôºö');
                if (newGroup && newGroup.trim() !== '' && !groups.includes(newGroup)) {
                    groups.push(newGroup.trim());
                    saveData();
                    renderUI();
                } else if (groups.includes(newGroup)) {
                    alert('Ë©≤Áæ§ÁµÑÂêçÁ®±Â∑≤Â≠òÂú®ÔºÅ');
                }
            }

            function startEditGroup(oldGroupName) {
                const newGroupName = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁæ§ÁµÑÂêçÁ®±Ôºö', oldGroupName);

                if (!newGroupName || newGroupName.trim() === '' || newGroupName.trim() === oldGroupName) {
                    return; // User cancelled or entered same/empty name
                }
                if (groups.includes(newGroupName.trim())) {
                    alert('Ë©≤Áæ§ÁµÑÂêçÁ®±Â∑≤Â≠òÂú®ÔºÅ');
                    return;
                }

                const finalNewName = newGroupName.trim();

                // Update group name in the groups array
                const groupIndex = groups.indexOf(oldGroupName);
                if (groupIndex > -1) {
                    groups[groupIndex] = finalNewName;
                }

                // Update group name for all associated locations
                locations.forEach(loc => {
                    if (loc.group === oldGroupName) {
                        loc.group = finalNewName;
                    }
                });

                saveData();
                renderUI();
                showStatus('‚úì Áæ§ÁµÑÂ∑≤Êõ¥Êñ∞', 'success');
            }

            function deleteGroup(groupName) {
                const isGroupInUse = locations.some(loc => loc.group === groupName);
                if (isGroupInUse) {
                    alert(`ÁÑ°Ê≥ïÂà™Èô§Áæ§ÁµÑ "${groupName}"ÔºåÂõ†ÁÇ∫Ë£°Èù¢ÈÇÑÊúâÂú∞Èªû„ÄÇ\nË´ãÂÖàÂ∞áÂú∞ÈªûÁßªËá≥ÂÖ∂‰ªñÁæ§ÁµÑÂæåÂÜçË©¶„ÄÇ`);
                    return;
                }

                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Áæ§ÁµÑ "${groupName}" ÂóéÔºü`)) {
                    groups = groups.filter(g => g !== groupName);
                    saveData();
                    renderUI();
                    showStatus('Áæ§ÁµÑÂ∑≤Âà™Èô§', 'success');
                }
            }

            function showStatus(message, type = '') {
                statusDiv.textContent = message;
                statusDiv.className = type;
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }

            // --- Event Listeners ---
            showFormBtn.addEventListener('click', () => {
                resetFormState();
                addForm.style.display = 'block';
                showFormBtn.style.display = 'none';
                addressInput.focus();
            });

            cancelBtn.addEventListener('click', resetFormState);
            saveBtn.addEventListener('click', handleSave);
            addGroupBtn.addEventListener('click', addNewGroup);

            locationsContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('delete-btn')) {
                    const id = parseInt(target.dataset.id, 10);
                    deleteLocation(id);
                } else if (target.classList.contains('edit-btn')) {
                    const id = parseInt(target.dataset.id, 10);
                    startEdit(id);
                }
            });

            groupsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const groupName = target.dataset.groupName;
                if (!groupName) return;

                if (target.classList.contains('edit-group-btn')) {
                    startEditGroup(groupName);
                } else if (target.classList.contains('delete-group-btn')) {
                    deleteGroup(groupName);
                }
            });

            // --- Initialization ---
            loadData();
            initMap();
            renderUI();
        });
    </script>
</body>

</html>